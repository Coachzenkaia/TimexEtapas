<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>TimexEtapas - Historial</title>
    <script src="https://p.trellocdn.com/power-up.min.js"></script>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 15px;
            font-size: 14px;
            background: #f4f5f7;
        }
        .header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #0079bf;
        }
        .header h2 {
            margin: 0;
            color: #0079bf;
            font-size: 18px;
        }
        .current-time {
            background: #e4f7ff;
            border: 1px solid #0079bf;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 15px;
        }
        .current-time .label {
            font-weight: bold;
            color: #0079bf;
            font-size: 12px;
            text-transform: uppercase;
        }
        .current-time .time {
            font-size: 24px;
            font-weight: bold;
            color: #0079bf;
            margin: 5px 0;
        }
        .current-time .list-name {
            font-size: 14px;
            color: #5e6c84;
        }
        .history-section {
            margin-bottom: 20px;
        }
        .history-title {
            font-weight: bold;
            color: #5e6c84;
            font-size: 12px;
            text-transform: uppercase;
            margin-bottom: 10px;
            letter-spacing: 0.5px;
        }
        .history-item {
            background: white;
            border: 1px solid #dfe1e6;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .history-item.current {
            background: #e4f7ff;
            border-color: #0079bf;
        }
        .list-info {
            flex: 1;
        }
        .list-name { 
            font-weight: bold;
            color: #172b4d;
            margin-bottom: 4px;
        }
        .list-period {
            font-size: 12px;
            color: #5e6c84;
        }
        .time-spent { 
            font-weight: bold;
            font-size: 16px;
            color: #0079bf;
        }
        .time-spent.long {
            color: #d04437;
        }
        .loading { 
            text-align: center; 
            padding: 20px;
            color: #5e6c84;
        }
        .no-data {
            text-align: center;
            padding: 30px;
            color: #5e6c84;
            font-style: italic;
        }
        .total-time {
            background: #f4f5f7;
            border: 1px solid #dfe1e6;
            border-radius: 6px;
            padding: 12px;
            text-align: center;
            margin-top: 15px;
        }
        .total-time .label {
            font-size: 12px;
            color: #5e6c84;
            text-transform: uppercase;
            font-weight: bold;
        }
        .total-time .time {
            font-size: 18px;
            font-weight: bold;
            color: #172b4d;
            margin-top: 4px;
        }
    </style>
</head>
<body>
    <div class="header">
        <h2>üìä TimexEtapas</h2>
    </div>
    
    <div id="content">
        <div class="loading">‚è≥ Cargando historial...</div>
    </div>
    
    <script>
        var t = TrelloPowerUp.iframe();
        
        t.render(function() {
            return Promise.all([
                t.card('all'),
                t.lists('all')
            ]).then(function(data) {
                var card = data[0];
                var lists = data[1];
                
                return t.get(card.id, 'shared', 'timexetapas_history', [])
                    .then(function(history) {
                        displayHistory(history, lists, card);
                    });
            }).catch(function(error) {
                document.getElementById('content').innerHTML = 
                    '<div class="no-data">‚ùå Error al cargar los datos</div>';
            });
        });
        
        function displayHistory(history, lists, card) {
            var content = document.getElementById('content');
            
            if (history.length === 0) {
                content.innerHTML = '<div class="no-data">üìù No hay historial disponible.<br>El tracking comenzar√° ahora.</div>';
                return;
            }
            
            // Actualizar nombres de listas en el historial
            history.forEach(function(entry) {
                var list = lists.find(function(l) { return l.id === entry.listId; });
                entry.listName = list ? list.name : 'Lista eliminada';
            });
            
            var html = '';
            var totalTime = 0;
            
            // Mostrar tiempo actual en lista
            var currentEntry = history.find(function(entry) {
                return entry.listId === card.idList && !entry.endDate;
            });
            
            if (currentEntry) {
                var currentTime = calculateTimeSpent(currentEntry);
                html += '<div class="current-time">';
                html += '<div class="label">‚è±Ô∏è Tiempo en Lista Actual</div>';
                html += '<div class="time">' + currentTime.formatted + '</div>';
                html += '<div class="list-name">üìã ' + currentEntry.listName + '</div>';
                html += '</div>';
            }
            
            // Mostrar historial completo
            html += '<div class="history-section">';
            html += '<div class="history-title">üìö Historial Completo</div>';
            
            // Ordenar historial por fecha (m√°s reciente primero)
            var sortedHistory = history.slice().sort(function(a, b) {
                return new Date(b.startDate) - new Date(a.startDate);
            });
            
            sortedHistory.forEach(function(entry) {
                var timeSpent = calculateTimeSpent(entry);
                var isCurrent = entry.listId === card.idList && !entry.endDate;
                var timeClass = timeSpent.totalMinutes > 4320 ? 'long' : ''; // m√°s de 3 d√≠as
                
                totalTime += timeSpent.totalMinutes;
                
                html += '<div class="history-item' + (isCurrent ? ' current' : '') + '">';
                html += '<div class="list-info">';
                html += '<div class="list-name">üìã ' + entry.listName + (isCurrent ? ' (Actual)' : '') + '</div>';
                html += '<div class="list-period">' + formatPeriod(entry) + '</div>';
                html += '</div>';
                html += '<div class="time-spent ' + timeClass + '">' + timeSpent.formatted + '</div>';
                html += '</div>';
            });
            
            // Mostrar tiempo total
            html += '</div>';
            html += '<div class="total-time">';
            html += '<div class="label">‚è∞ Tiempo Total</div>';
            html += '<div class="time">' + formatTotalTime(totalTime) + '</div>';
            html += '</div>';
            
            content.innerHTML = html;
        }
        
        function calculateTimeSpent(entry) {
            var start = new Date(entry.startDate);
            var end = entry.endDate ? new Date(entry.endDate) : new Date();
            var diffMs = end - start;
            
            var totalMinutes = Math.floor(diffMs / (1000 * 60));
            var hours = Math.floor(totalMinutes / 60);
            var minutes = totalMinutes % 60;
            var days = Math.floor(hours / 24);
            var remainingHours = hours % 24;
            
            var formatted;
            if (days > 0) {
                formatted = days + 'd ' + remainingHours + 'h';
            } else if (hours > 0) {
                formatted = hours + 'h ' + minutes + 'm';
            } else {
                formatted = minutes + 'm';
            }
            
            return {
                days: days,
                hours: remainingHours,
                minutes: minutes,
                totalMinutes: totalMinutes,
                formatted: formatted
            };
        }
        
        function formatPeriod(entry) {
            var start = new Date(entry.startDate);
            var end = entry.endDate ? new Date(entry.endDate) : new Date();
            
            var startStr = start.toLocaleDateString() + ' ' + start.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            if (entry.endDate) {
                var endStr = end.toLocaleDateString() + ' ' + end.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                return startStr + ' ‚Üí ' + endStr;
            } else {
                return 'Desde: ' + startStr;
            }
        }
        
        function formatTotalTime(totalMinutes) {
            var hours = Math.floor(totalMinutes / 60);
            var minutes = totalMinutes % 60;
            var days = Math.floor(hours / 24);
            var remainingHours = hours % 24;
            
            if (days > 0) {
                return days + 'd ' + remainingHours + 'h ' + minutes + 'm';
            } else if (hours > 0) {
                return hours + 'h ' + minutes + 'm';
            } else {
                return minutes + 'm';
            }
        }
    </script>
</body>
</html>