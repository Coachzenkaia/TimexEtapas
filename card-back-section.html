<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <link rel="stylesheet" href="https://p.trellocdn.com/power-up.min.css">
  <style>
    body {
      font-family: 'Helvetica Neue', Arial, sans-serif;
      font-size: 14px;
      padding: 15px;
    }
    ul {
      padding-left: 20px;
    }
  </style>
</head>
<body>
  <h4>Tiempo por Lista</h4>
  <div id="content">Cargando historial...</div>

  <script src="https://p.trellocdn.com/power-up.min.js"></script>
  <script>
    const t = TrelloPowerUp.iframe();

    const formatDuration = (ms) => {
      const minutes = Math.floor(ms / 60000);
      const hours = Math.floor(minutes / 60);
      const days = Math.floor(hours / 24);
      if (days > 0) return `${days} día(s)`;
      if (hours > 0) return `${hours} hora(s)`;
      return `${minutes} minuto(s)`;
    };

    const loadListTimes = async () => {
      const card = await t.card('id', 'name');
      const actions = await t.card('actions');
      const moveActions = actions.filter(a => a.type === 'updateCard' && a.data.listAfter && a.data.listBefore);

      moveActions.reverse(); // orden cronológico
      let currentList = null;
      let listTimes = [];

      let lastTimestamp = new Date(card.dateLastActivity).getTime();

      for (const action of moveActions) {
        const fromList = action.data.listBefore.name;
        const toList = action.data.listAfter.name;
        const timeMoved = new Date(action.date).getTime();
        if (currentList === null) {
          currentList = toList;
        }

        listTimes.push({
          list: fromList,
          time: lastTimestamp - timeMoved
        });

        lastTimestamp = timeMoved;
      }

      if (currentList) {
        listTimes.push({
          list: currentList,
          time: Date.now() - lastTimestamp
        });
      }

      const html = listTimes.map(entry =>
        `<li><strong>${entry.list}:</strong> ${formatDuration(entry.time)}</li>`
      ).join('');

      document.getElementById('content').innerHTML = `<ul>${html}</ul>`;
    };

    loadListTimes();
  </script>
</body>
</html>
