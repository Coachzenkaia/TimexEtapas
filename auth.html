<!-- auth.html - VERSIÓN FINAL -->
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="https://p.trellocdn.com/power-up.min.css">
    <script src="https://p.trellocdn.com/power-up.min.js"></script>
    <style>
        body { text-align: center; padding: 20px; }
        button { font-size: 16px; }
    </style>
</head>
<body>
    <p>Haz clic para conectar tu cuenta de Trello.</p>
    <button id="auth-btn" class="mod-primary">Autorizar</button>

    <script>
        const t = window.TrelloPowerUp.iframe();
        const API_KEY = '96e6f5f73e3878e9f40bd3d241f8b732';

        document.getElementById('auth-btn').addEventListener('click', function() {
            // Este es el método correcto para pedir autorización DESDE un popup
            t.getRestApi()
                .authorize({
                    requestKey: 'read', // Coincide con el 'scope' que pediremos
                    scope: 'read',
                    expiration: 'never',
                })
                .then(function(token) {
                    // El usuario autorizó, Trello nos da el token
                    return t.set('member', 'private', 'token', token);
                })
                .then(function() {
                    // Token guardado, ahora cerramos el popup
                    return t.closePopup();
                })
                .catch(function(error) {
                    console.error('Proceso de autorización cancelado o fallido', error);
                    // Opcional: podrías mostrar un mensaje de error antes de cerrar
                    t.closePopup(); 
                });
        });
    </script>
</body>
</html>